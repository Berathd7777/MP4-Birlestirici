<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>🎥 MP4 Videoları Birleştirici</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  
  <!-- MP4Box.js yerine FFmpeg.wasm kütüphanesi -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.7/dist/ffmpeg.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "Roboto", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      display: flex;
      align-items: center;
      gap: 12px;
      color: #667eea;
      font-size: 2rem;
      margin: 0 0 10px 0;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 0.95rem;
    }
    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin-bottom: 25px;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #1565c0;
    }
    .input-section {
      margin-bottom: 25px;
    }
    .input-section label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
      font-size: 1.05rem;
    }
    input[type="file"] {
      width: 100%;
      padding: 12px;
      border: 2px dashed #ddd;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      background: #f9f9f9;
    }
    input[type="file"]:hover {
      border-color: #667eea;
      background: #f0f0ff;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 0.95rem;
      transition: all 0.3s;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }
    .divider {
      text-align: center;
      margin: 15px 0;
      color: #999;
      font-size: 0.9rem;
    }
    .btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 30px;
    }
    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    #progress {
      margin-top: 30px;
      background: #f5f5f5;
      padding: 20px;
      border-radius: 12px;
      display: none;
    }
    .step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      color: #666;
      transition: all 0.3s;
    }
    .step-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.3s;
    }
    .step.active {
      color: #667eea;
      font-weight: 600;
    }
    .step.active .step-icon {
      background: #667eea;
      color: white;
      animation: pulse 1.5s infinite;
    }
    .step.done {
      color: #4caf50;
    }
    .step.done .step-icon {
      background: #4caf50;
      color: white;
    }
    .step.error {
      color: #f44336;
    }
    .step.error .step-icon {
      background: #f44336;
      color: white;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    #log {
      margin-top: 15px;
      background: #2d2d2d;
      color: #0f0;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      white-space: pre-wrap;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      <span class="material-symbols-outlined">movie_filter</span>
      MP4 Birleştirici
    </h1>
    <p class="subtitle">Intro videonuzu ana videonun başına ekleyin</p>

    <div class="info-box">
      💡 <strong>FFmpeg.wasm</strong> kullanılarak profesyonel video birleştirme
    </div>

    <div class="input-section">
      <label>🎬 Intro Videosu (Başa Eklenecek)</label>
      <input id="introFile" type="file" accept="video/mp4">
    </div>

    <div class="input-section">
      <label>🎥 Ana Video</label>
      <input id="mainFile" type="file" accept="video/mp4">
      <div class="divider">— veya —</div>
      <input id="videoUrl" type="text" placeholder="Herkese açık MP4 linki yapıştırın">
    </div>

    <button class="btn" id="runBtn">
      <span class="material-symbols-outlined">rocket_launch</span>
      Birleştir ve İndir
    </button>
    
    <div id="progress">
      <div class="step" data-step="0">
        <div class="step-icon">
          <span class="material-symbols-outlined">cloud_download</span>
        </div>
        <span class="text">FFmpeg kütüphanesi yükleniyor...</span>
      </div>
      <div class="step" data-step="1">
        <div class="step-icon">
          <span class="material-symbols-outlined">upload</span>
        </div>
        <span class="text">Intro videosu işleniyor...</span>
      </div>
      <div class="step" data-step="2">
        <div class="step-icon">
          <span class="material-symbols-outlined">download</span>
        </div>
        <span class="text">Ana video işleniyor...</span>
      </div>
      <div class="step" data-step="3">
        <div class="step-icon">
          <span class="material-symbols-outlined">merge</span>
        </div>
        <span class="text">Videolar birleştiriliyor...</span>
      </div>
      <div class="step" data-step="4">
        <div class="step-icon">
          <span class="material-symbols-outlined">download_done</span>
        </div>
        <span class="text">Video indiriliyor...</span>
      </div>
    </div>
    
    <div id="log"></div>
  </div>

  <script>
    const { FFmpeg } = FFmpegWASM; // FFmpeg.wasm kütüphanesini içeri aktar
    const introInput = document.getElementById('introFile');
    const mainInput = document.getElementById('mainFile');
    const urlInput = document.getElementById('videoUrl');
    const runBtn = document.getElementById('runBtn');
    const logEl = document.getElementById('log');
    const progressDiv = document.getElementById('progress');
    const steps = document.querySelectorAll('.step');

    let ffmpeg = null; // FFmpeg instance'ı globalde tutulacak

    function log(msg) {
      console.log(msg);
      logEl.textContent += msg + '\n';
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateStep(index, status) {
      const step = steps[index];
      if (!step) return;
      
      steps.forEach((s, i) => {
        if (i < index && !s.classList.contains('error')) {
          s.classList.add('done');
          s.classList.remove('active');
          const icon = s.querySelector('.step-icon .material-symbols-outlined');
          icon.textContent = 'check_circle';
        } else {
          s.classList.remove('active', 'done', 'error');
        }
      });
      
      // İlk adımların ikonlarını özel olarak resetle
      if (index === 0) steps[0].querySelector('.step-icon .material-symbols-outlined').textContent = 'cloud_download';
      if (index === 1) steps[1].querySelector('.step-icon .material-symbols-outlined').textContent = 'upload';
      if (index === 2) steps[2].querySelector('.step-icon .material-symbols-outlined').textContent = 'download';
      if (index === 3) steps[3].querySelector('.step-icon .material-symbols-outlined').textContent = 'merge';
      if (index === 4) steps[4].querySelector('.step-icon .material-symbols-outlined').textContent = 'download_done';


      if (status === 'active') {
        step.classList.add('active');
      } else if (status === 'done') {
        step.classList.add('done');
        const icon = step.querySelector('.step-icon .material-symbols-outlined');
        icon.textContent = 'check_circle';
      } else if (status === 'error') {
        step.classList.add('error');
        const icon = step.querySelector('.step-icon .material-symbols-outlined');
        icon.textContent = 'error';
      }
    }

    function checkInputsAndToggleRunButton() {
      const hasIntroFile = introInput.files.length > 0;
      const hasMainFile = mainInput.files.length > 0;
      const hasVideoUrl = urlInput.value.trim() !== '';

      runBtn.disabled = !(hasIntroFile && (hasMainFile || hasVideoUrl));
    }

    checkInputsAndToggleRunButton();
    introInput.onchange = checkInputsAndToggleRunButton;
    mainInput.onchange = checkInputsAndToggleRunButton;
    urlInput.oninput = checkInputsAndToggleRunButton;


    async function readFileAsArrayBuffer(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    async function fetchVideoAsArrayBuffer(url) {
      const response = await fetch(url);
      if (!response.ok) throw new Error('Video indirilemedi: ' + response.statusText);
      return await response.arrayBuffer();
    }

    async function initializeFFmpeg() {
      if (ffmpeg) return; // Zaten yüklüyse tekrar yükleme
      
      updateStep(0, 'active');
      log('FFmpeg kütüphanesi başlatılıyor...');
      ffmpeg = new FFmpeg();

      // FFmpeg loglarını konsola aktar
      ffmpeg.on('log', ({ message }) => log(`FFmpeg Log: ${message}`));
      // FFmpeg progress'ini takip et (isteğe bağlı, daha detaylı bir ilerleme çubuğu için)
      ffmpeg.on('progress', ({ progress, time }) => {
        // Log elementine veya ayrı bir ilerleme çubuğuna yazabilirsiniz
        // log(`FFmpeg İlerleme: %${(progress * 100).toFixed(0)}, Zaman: ${time}`);
      });

      try {
        await ffmpeg.load({
          coreURL: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.7/dist/ffmpeg-core.js',
          wasmURL: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.7/dist/ffmpeg-core.wasm',
          workerURL: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.7/dist/ffmpeg-core.worker.js',
        });
        log('FFmpeg başarıyla yüklendi.');
        updateStep(0, 'done');
      } catch (error) {
        log(`HATA: FFmpeg yüklenirken bir sorun oluştu: ${error.message}`);
        updateStep(0, 'error');
        throw error;
      }
    }

    async function mergeVideosFFmpeg(introBuffer, mainBuffer) {
      log('FFmpeg ile videolar birleştiriliyor...');
      
      const introFileName = 'intro.mp4';
      const mainFileName = 'main.mp4';
      const outputFileName = 'birlesik_video.mp4';
      const fileListFileName = 'filelist.txt';

      // FFmpeg sanal dosya sistemine dosyaları yaz
      log(`Intro videosu (${introFileName}) FFmpeg FS'ye yazılıyor...`);
      ffmpeg.writeFile(introFileName, new Uint8Array(introBuffer));
      log(`Ana video (${mainFileName}) FFmpeg FS'ye yazılıyor...`);
      ffmpeg.writeFile(mainFileName, new Uint8Array(mainBuffer));

      // Birleştirme için dosya listesi oluştur
      const fileListContent = `file '${introFileName}'\nfile '${mainFileName}'`;
      log(`Birleştirme listesi (${fileListFileName}) FFmpeg FS'ye yazılıyor...`);
      ffmpeg.writeFile(fileListFileName, new TextEncoder().encode(fileListContent));

      // FFmpeg komutunu çalıştır
      // -f concat: concat demuxer kullan
      // -safe 0: concat demuxer'ın göreli yolları (veya güvenli olmayan yolları) kabul etmesini sağlar
      // -i filelist.txt: Giriş olarak dosya listesini kullan
      // -c copy: Video ve ses akışlarını yeniden kodlamadan kopyala (hızlı ve kayıpsız)
      // output.mp4: Çıktı dosyası adı
      log('FFmpeg birleştirme komutu yürütülüyor...');
      await ffmpeg.exec([
        '-f', 'concat',
        '-safe', '0',
        '-i', fileListFileName,
        '-c', 'copy',
        outputFileName
      ]);
      log('FFmpeg birleştirme komutu tamamlandı.');

      // Çıktı dosyasını sanal dosya sisteminden oku
      log(`Birleştirilmiş video (${outputFileName}) FFmpeg FS'den okunuyor...`);
      const data = ffmpeg.readFile(outputFileName);
      return data.buffer; // ArrayBuffer olarak döndür
    }

    runBtn.onclick = async () => {
      if (runBtn.disabled) {
        alert('Lütfen hem intro videosu hem de ana video (dosya veya link) seçin.');
        return;
      }

      runBtn.disabled = true;
      progressDiv.style.display = 'block';
      logEl.style.display = 'block';
      logEl.textContent = '';
      
      steps.forEach((step, index) => { // Her yeni çalıştırmada ikonları sıfırla
        step.classList.remove('active', 'done', 'error');
        const icon = step.querySelector('.step-icon .material-symbols-outlined');
        // İlk yükleme adımı için başlangıç ikonu
        if (index === 0) icon.textContent = 'cloud_download';
        else if (index === 1) icon.textContent = 'upload';
        else if (index === 2) icon.textContent = 'download';
        else if (index === 3) icon.textContent = 'merge';
        else if (index === 4) icon.textContent = 'download_done';
      });

      try {
        // Adım 0: FFmpeg kütüphanesini yükle/başlat
        await initializeFFmpeg(); // FFmpeg sadece bir kez yüklenecek
        updateStep(0, 'done'); // FFmpeg yüklendiyse adımı tamamla

        // Adım 1: Intro oku
        updateStep(1, 'active');
        log('Intro videosu okunuyor...');
        const introBuffer = await readFileAsArrayBuffer(introInput.files[0]);
        log(`Intro yüklendi: ${(introBuffer.byteLength / 1024 / 1024).toFixed(2)} MB`);
        updateStep(1, 'done');
        
        // Adım 2: Ana video oku
        updateStep(2, 'active');
        let mainBuffer;
        if (mainInput.files[0]) {
          log('Ana video dosyadan okunuyor...');
          mainBuffer = await readFileAsArrayBuffer(mainInput.files[0]);
        } else {
          log('Ana video linkten indiriliyor...');
          mainBuffer = await fetchVideoAsArrayBuffer(urlInput.value.trim());
        }
        log(`Ana video yüklendi: ${(mainBuffer.byteLength / 1024 / 1024).toFixed(2)} MB`);
        updateStep(2, 'done');
        
        // Adım 3: Birleştir (FFmpeg ile)
        updateStep(3, 'active');
        const mergedBuffer = await mergeVideosFFmpeg(introBuffer, mainBuffer);
        log(`Toplam boyut: ${(mergedBuffer.byteLength / 1024 / 1024).toFixed(2)} MB`);
        updateStep(3, 'done');
        
        // Adım 4: İndir
        updateStep(4, 'active');
        log('Video indiriliyor...');
        const blob = new Blob([mergedBuffer], { type: 'video/mp4' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'birlesik_video.mp4';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        log('İndirme başarılı!');
        updateStep(4, 'done');
        
        alert('✅ Video başarıyla birleştirildi ve indirildi!');
        
      } catch (error) {
        console.error('Hata:', error);
        log(`HATA: ${error.message}`);
        const activeStepIndex = Array.from(steps).findIndex(s => s.classList.contains('active'));
        if (activeStepIndex >= 0) updateStep(activeStepIndex, 'error');
        alert('❌ Bir hata oluştu: ' + error.message);
      } finally {
        runBtn.disabled = false;
        checkInputsAndToggleRunButton();
      }
    };
  </script>
</body>
</html>
